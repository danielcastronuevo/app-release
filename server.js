const s=require("./data/colors"),f=require("express"),j=require("http"),m=require("path"),p=require("fs"),{Server:q}=require("socket.io"),{io:P}=require("socket.io-client"),{configurarPartido:I}=require("./logic/configurator"),r=f(),E=j.createServer(r),a=new q(E);function y(e){console.log(`${s.rojo}[!]${s.reset} ${e}`)}function h(e){console.log(`${s.cyan}[i]${s.reset} ${e}`)}function $(e){console.log(`${s.amarillo}[!]${s.reset} ${e}`)}function _(e){console.log(`${s.verde}[+]${s.reset} ${e}`)}const S=m.join(__dirname,"config.json");p.existsSync(S)||(y("No se encontr\xF3 config.json en la ra\xEDz del proyecto"),process.exit(1));const l=JSON.parse(p.readFileSync(S,"utf8")),R=l.vps_url,c=l.raspy_id,o=require("./logic/match");o.resetEstado&&o.resetEstado(),o.setOnChange(()=>{const e=o.getEstado();a.emit("estado",e),a.emit("resumen",o.getResumen()),a.emit("menu",o.menu),a.emit("menuSacador",o.menuSacador),a.emit("esperando",{enEspera:o.estaEnEspera()}),i.connected&&i.emit("estado_cancha",{raspy_id:c,enEspera:o.estaEnEspera(),estado:e})});const C=300*1e3;o.iniciarSincronizacionPeriodica(C),r.use(f.json()),r.use(f.static(m.join(__dirname,"public")));const O=require("./routes/config")(a),b=require("./routes/sensors"),v=require("./routes/history");r.use("/api/config",O),r.use("/api/sensors",b),r.use("/api/history",v),r.get("/api/partido-estado",(e,n)=>{const t=o.getEstado();n.json({enCurso:t?.ocupada||!1,enEspera:o.estaEnEspera()})}),r.get("/api/raspy-id",(e,n)=>{n.json({raspy_id:c})}),r.get("/api/config-info",(e,n)=>{n.json({raspy_id:c,club:l.club||"sin-configurar"})}),r.get("/api/sync-status",(e,n)=>{const t=o.obtenerPartidosPendientes();n.json({pendientes:t.length,partidos:t.map(u=>({matchId:u.matchId,archivo:u.archivo}))})}),r.post("/api/sync-now",async(e,n)=>{try{await o.sincronizarPartidosPendientes(),n.json({ok:!0,mensaje:"Sincronizaci\xF3n iniciada"})}catch(t){n.status(500).json({ok:!1,error:t.message})}}),r.get("/api/historial",(e,n)=>{try{const t=m.join(__dirname,"logs","historial.json");if(!p.existsSync(t))return n.json({historial:[],mensaje:"No hay historial disponible"});const u=JSON.parse(p.readFileSync(t,"utf-8"));n.json({historial:u})}catch(t){console.error("\u274C Error leyendo historial:",t),n.status(500).json({error:"Error leyendo historial"})}}),r.get("/api/estado-actual",(e,n)=>{try{const t=o.getHistorialActual();n.json({estadoActual:t})}catch(t){console.error("\u274C Error generando estado actual:",t),n.status(500).json({error:"Error generando estado actual"})}}),a.on("connection",e=>{_(`Cliente conectado: ${e.id}`);const n=o.getEstado();e.emit("estado",n),e.emit("resumen",o.getResumen()),e.emit("menu",o.menu),e.emit("menuSacador",o.menuSacador),e.emit("esperando",{enEspera:o.estaEnEspera()}),e.on("disconnect",()=>{$(`Cliente desconectado: ${e.id}`)})});const i=P(R,{reconnectionAttempts:999,reconnectionDelay:2e3});i.on("connect",()=>{_("Conectado a VPS"),i.emit("register_raspy",{raspy_id:c,club:l.club});const e=o.getEstado();i.emit("estado_cancha",{raspy_id:c,enEspera:o.estaEnEspera(),estado:e})}),i.on("disconnect",()=>{y("Desconectado de VPS")}),i.on(`config_${c}`,e=>{h("Datos recibidos desde VPS"),I(e,a)});const A=require("os"),d=process.env.PORT||5e3;function N(){const e=A.networkInterfaces();for(const n of Object.values(e))for(const t of n)if(t.family==="IPv4"&&!t.internal)return t.address;return"localhost"}const g=N();console.log(s.cyan),console.log("_____________________                          "),console.log("____    |__  /__  __/___________ ____  ______ "),console.log("___  /| |_  /__  /  _  __ \\  __ `/  / / /  _ \\"),console.log("__  ___ |  / _  /   / /_/ / /_/ // /_/ //  __/"),console.log("_/_/  |_/_/  /_/    \\____/\\__, / \\__,_/ \\___/ "),console.log("                            /_/               "),console.log(`${s.cyan}>_ CONTADOR DE PADEL${s.reset}
`),E.listen(d,()=>{console.log(""),h("Links:"),_(`Configuraci\xF3n VPS:     ${s.cyan}https://config.altoquepadel.com/?id=${c}&club=${l.club}${s.reset}`),_(`Sensores:              ${s.cyan}http://${g}:${d}/sensors${s.reset}`),_(`Contador:              ${s.cyan}http://${g}:${d}/counter${s.reset}`),$(`Servidor:              ${s.amarillo}http://${g}:${d}${s.reset}`),$(`Configuraci\xF3n local:   ${s.amarillo}http://${g}:${d}/config${s.reset}
`)});
