const z=io();z.on("esperando",e=>{e.enEspera?A(!1):A(!0)});const D=document.getElementById("step1-next"),p=document.getElementById("estado-cancha"),k=document.getElementById("cancha-msg"),s=document.getElementById("duracion"),y=document.querySelector("#step4 .finish"),u=document.getElementById("inicio-partido"),h=document.getElementById("fin-partido");let v={};const H=document.getElementById("step1-error"),i=[document.getElementById("p1j1"),document.getElementById("p1j2"),document.getElementById("p2j1"),document.getElementById("p2j2")],l=[document.getElementById("bracelet-team1"),document.getElementById("bracelet-team2")],V=document.getElementById("step3-next"),L=document.getElementsByName("calentamiento"),b=document.getElementsByName("cambio"),I=document.getElementsByName("games"),q=document.querySelectorAll(".step");let f=0,w=!1,g={inicioTexto:"",finTexto:"",inicioFecha:"",finFecha:""},a={jugadores:{pareja1:{j1:"",j2:"",pulsera:""},pareja2:{j1:"",j2:"",pulsera:""}},sacadores:{pareja1:"",pareja2:""},modosJuego:{calentamiento:"",cambio:"",games:""},duracion:"",comienzo:"Hoy 20:00"};window.addEventListener("DOMContentLoaded",()=>{document.querySelectorAll('input[type="text"]').forEach(e=>e.value=""),document.querySelectorAll("select").forEach(e=>e.selectedIndex=0),document.querySelectorAll('input[type="radio"]').forEach(e=>e.checked=!1),D.disabled=!0,fetch("bracelets.json").then(e=>e.json()).then(e=>{v=e,G()}).catch(e=>console.error("Error cargando pulseras:",e))});function G(){l.forEach(e=>{e.innerHTML='<option value="" disabled selected hidden class="placeholder">Seleccionar Pulsera</option>',Object.entries(v).forEach(([n,o])=>{const r=document.createElement("option");r.value=n,r.textContent=`${n} (${o})`,e.appendChild(r)})})}function N(){const e=s.value;y.disabled=!(e&&!w)}function A(e){w=e,e?(p.classList.remove("cancha-libre"),p.classList.add("cancha-ocupada"),p.querySelector(".texto-estado").textContent="CANCHA NO DISPONIBLE",k.style.display="flex"):(p.classList.remove("cancha-ocupada"),p.classList.add("cancha-libre"),p.querySelector(".texto-estado").textContent="CANCHA DISPONIBLE",k.style.display="none"),N()}function M(){let e=!0;H.style.display="none";const n=[];i.forEach(t=>{t.classList.remove("error"),t.value.trim()||(e=!1),n.push(t.value.trim())});const o=[];l.forEach(t=>{t.classList.remove("error"),t.value||(e=!1),o.push(t.value)});const r=n.filter((t,c,j)=>t&&j.indexOf(t)!==c);r.length>0&&(e=!1,i.forEach(t=>{r.includes(t.value.trim())&&t.classList.add("error")})),o[0]&&o[1]&&o[0]===o[1]&&(e=!1,l.forEach(t=>t.classList.add("error"))),H.style.display=e?"none":"block",D.disabled=!e}function O(){a.jugadores.pareja1.j1=i[0].value.trim(),a.jugadores.pareja1.j2=i[1].value.trim(),a.jugadores.pareja2.j1=i[2].value.trim(),a.jugadores.pareja2.j2=i[3].value.trim(),a.jugadores.pareja1.pulsera=l[0].value,a.jugadores.pareja2.pulsera=l[1].value,M()}function R(){i[0].value=a.jugadores.pareja1.j1,i[1].value=a.jugadores.pareja1.j2,i[2].value=a.jugadores.pareja2.j1,i[3].value=a.jugadores.pareja2.j2,l[0].value=a.jugadores.pareja1.pulsera||"",l[1].value=a.jugadores.pareja2.pulsera||"",M()}i.forEach(e=>e.addEventListener("input",O)),l.forEach(e=>e.addEventListener("change",O));function B(e){return Array.from(e).some(n=>n.checked)}function F(){const e=B(L)&&B(b)&&B(I);V.disabled=!e}function K(){a.modosJuego.calentamiento=document.querySelector('input[name="calentamiento"]:checked')?.value||"",a.modosJuego.cambio=document.querySelector('input[name="cambio"]:checked')?.value||"",a.modosJuego.games=document.querySelector('input[name="games"]:checked')?.value||"",F()}function Q(){L.forEach(e=>e.checked=e.value===a.modosJuego.calentamiento),b.forEach(e=>e.checked=e.value===a.modosJuego.cambio),I.forEach(e=>e.checked=e.value===a.modosJuego.games),F()}[...L,...b,...I].forEach(e=>e.addEventListener("change",K)),h.value="";const d=document.createElement("div");d.classList.add("error-msg"),d.innerHTML='<i class="fa-solid fa-triangle-exclamation"></i> Debes seleccionar la duraci\xF3n del partido',s.parentNode.appendChild(d);function U(){const e=new Date;let n=e.getHours(),o=e.getMinutes(),r=n,t=o;o<=15?t=0:o<=45?t=30:(t=0,r+=1),r>=24&&(r-=24);const c=`${r.toString().padStart(2,"0")}:${t.toString().padStart(2,"0")}`,j=[],X=3;for(let S=-1;S<=2;S++){let C=r*60+t+S*30,m=Math.floor(C/60),$=C%60;m<0&&(m+=24),m>=24&&(m-=24),j.push(`${m.toString().padStart(2,"0")}:${$.toString().padStart(2,"0")}`)}return{options:j,defaultTime:c}}function J(){const e=new Date,[n,o]=u.value.split(":").map(Number),r=new Date;return r.setHours(n,o,0,0),s.value?new Date(r.getTime()+parseInt(s.value)*6e4)<=e?(d.style.display="block",d.innerHTML='<i class="fa-solid fa-triangle-exclamation"></i> El horario de finalizaci\xF3n no es v\xE1lido. Por favor, modific\xE1 la hora de inicio o la duraci\xF3n del partido.',s.classList.add("error"),y.disabled=!0,!1):(d.innerHTML='<i class="fa-solid fa-triangle-exclamation"></i> Debes seleccionar la duraci\xF3n del partido',x(),!0):!0}function E(){const{options:e,defaultTime:n}=U(),o=u.value;u.innerHTML="";let r=o&&e.includes(o);e.forEach(t=>{const c=document.createElement("option");c.value=t,c.textContent=t,r?t===o&&(c.selected=!0):t===n&&(c.selected=!0),u.appendChild(c)}),T()}function T(){if(!s.value){h.value="";return}const[e,n]=u.value.split(":").map(Number),o=new Date;o.setHours(e,n,0,0);const r=new Date(o.getTime()+parseInt(s.value)*6e4);r.getDate(),o.getDate(),h.value=`${r.getHours().toString().padStart(2,"0")}:${r.getMinutes().toString().padStart(2,"0")}`,g={inicioTexto:u.value,finTexto:h.value,inicioFecha:o.toISOString(),finFecha:r.toISOString()}}setInterval(E,6e4);function x(){s.value?(d.style.display="none",s.classList.remove("error")):(d.style.display="block",s.classList.add("error")),N()}function W(){s.value=a.duracion||"",x(),E()}s.addEventListener("change",()=>{a.duracion=s.value,x(),T(),J()}),u.addEventListener("change",()=>{T(),J()}),setInterval(E,6e4),E();function P(e){q.forEach((n,o)=>n.classList.toggle("active",o===e)),f=e,e===0&&R(),e===1&&Q(),e===2&&W()}document.querySelectorAll(".next").forEach(e=>e.addEventListener("click",()=>{f<q.length-1&&P(f+1)})),document.querySelectorAll(".prev").forEach(e=>e.addEventListener("click",()=>{f>0&&P(f-1)})),y.addEventListener("click",()=>{const e={jugadores:[a.jugadores.pareja1.j1,a.jugadores.pareja1.j2,a.jugadores.pareja2.j1,a.jugadores.pareja2.j2],parejas:{pareja1:[a.jugadores.pareja1.j1,a.jugadores.pareja1.j2],pareja2:[a.jugadores.pareja2.j1,a.jugadores.pareja2.j2]},parejaSacadora:"pareja1",sacadores:["",""],tiempoCalentamiento:(()=>{switch(a.modosJuego.calentamiento){case"0":return"Sin calentamiento";case"5":return"5 minutos";case"10":return"10 minutos";default:return""}})(),cambioDeLado:(()=>{switch(a.modosJuego.cambio){case"set":return"Al finalizar cada SET";case"tradicional":return"Tradicional (impares)";case"ninguno":return"Sin cambios";default:return""}})(),tipoGames:(()=>{switch(a.modosJuego.games){case"punto-oro":return"Punto de oro";case"deuce":return"Deuce / Advantage";default:return""}})(),ordenDeSaque:["","","",""],duracion:`${a.duracion} minutos`,comienzo:g.inicioTexto,fin:g.finTexto,inicioFecha:g.inicioFecha,finFecha:g.finFecha,pulseras:{pareja1:{nombre:a.jugadores.pareja1.pulsera,mac:v[a.jugadores.pareja1.pulsera]||""},pareja2:{nombre:a.jugadores.pareja2.pulsera,mac:v[a.jugadores.pareja2.pulsera]||""}}};console.log("\u{1F6E0}\uFE0F Partido configurado:",e),sendToServer(e)}),sendToServer=e=>{fetch("/api/config",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)}).then(n=>n.json()).then(n=>{console.log("Respuesta del servidor:",n)}).catch(n=>{console.error("Error enviando datos al servidor:",n),console.warn("\xBFEst\xE1s seguro de que el servidor est\xE1 corriendo?")})};
